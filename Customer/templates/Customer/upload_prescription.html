{% extends 'base.html' %}

{% block title %}Upload Prescription{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto bg-white p-10 rounded-xl shadow-lg">
    <div class="text-center mb-10">
        <h2 class="text-4xl font-bold text-green-600 mb-4 animate-fade-in">Upload Your Prescription</h2>
        <p class="text-gray-600 text-lg">Submit your doctor’s prescription to get medicines delivered to your address.</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-start">
        <!-- Form Section -->
        <form method="POST" enctype="multipart/form-data" class="space-y-6 animate-slide-in-left">
            {% csrf_token %}

            <!-- Prescription Upload -->
            <div>
                <label class="block mb-2 font-semibold">Prescription File <span class="text-red-500">*</span></label>
                <input type="file" name="prescription" accept="image/*,.pdf" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
                <p class="text-sm text-gray-500 mt-1">Formats: PDF, JPG, PNG. Max size: 5MB.</p>
            </div>

            <!-- Medical Store Search -->
             <!-- Medical Store Search -->
            <div class="relative">
                <label class="block mb-2 font-semibold">Search Medical Store <span class="text-red-500">*</span></label>
                <input type="text" id="store-search" placeholder="Type store name or address"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400 mb-2"
                       oninput="liveStoreSearch()" autocomplete="off">
                <input type="hidden" name="store" id="selected-store-id" required>

                <!-- Filtered store results -->
                <ul id="store-suggestions" class="border border-gray-300 rounded-lg max-h-60 overflow-y-auto hidden bg-white shadow z-10 absolute w-full">
                    <!-- Live suggestions injected here -->
                </ul>
            </div>

            <!-- Delivery Address Section -->
            <div>
                <label class="block mb-2 font-semibold">Delivery Address</label>

                <div class="space-y-2">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="address_option" value="saved" checked onchange="toggleAddress()" class="form-radio text-green-600">
                        <span>Use My Saved Address</span>
                    </label>

                    <label class="flex items-center space-x-2">
                        <input type="radio" name="address_option" value="new" onchange="toggleAddress()" class="form-radio text-green-600">
                        <span>Enter New Address</span>
                    </label>
                </div>

                <input type="text" name="address" id="delivery-address" value="{{ user.address }}"
                       class="w-full mt-3 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400"
                       placeholder="Enter your delivery address" readonly>
            </div>

            <!-- Notes Section -->
            <div>
                <label class="block mb-2 font-semibold">Notes</label>
                <textarea name="notes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400" rows="4"
                          placeholder="Any additional instructions or notes?">{{ user.notes }}</textarea>
            </div>

            <!-- Reminder Section -->
            <div>
                <label class="block mb-2 font-semibold">Set Reminder (Months)</label>
                <select name="reminder_months" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400">
                    <option value="">None</option>
                    <option value="1">1 Month</option>
                    <option value="3">3 Months</option>
                    <option value="6">6 Months</option>
                    <option value="12">12 Months</option>
                </select>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg text-lg shadow transition duration-200 transform hover:scale-105">
                Upload Prescription
            </button>
        </form>

        <!-- Visual Guide Section -->
        <div class="animate-slide-in-right">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">How to Upload</h3>
            <img src="https://medspotpk.com/wp-content/uploads/2025/02/IMG_8730.jpeg" alt="Upload Guide"
                 class="w-full h-64 object-cover rounded-lg shadow-md mb-4">

            <ul class="list-disc list-inside text-gray-600 space-y-2">
                <li>
                    Ensure the prescription is clear and complete. <br>
                    <span class="text-sm text-gray-500">प्रिस्क्रिप्शन स्पष्ट आणि संपूर्ण असावे.</span>
                </li>
                <li>
                    Doctor’s name, date, and signature should be visible. <br>
                    <span class="text-sm text-gray-500">डॉक्टरांचे नाव, तारीख आणि स्वाक्षरी दिसायला हवी.</span>
                </li>
                <li>
                    Upload recent prescriptions (within 2 months). <br>
                    <span class="text-sm text-gray-500">अलीकडील (२ महिन्यांच्या आतली) प्रिस्क्रिप्शन अपलोड करा.</span>
                </li>
                <li>
                    Do not crop or edit your prescription image. <br>
                    <span class="text-sm text-gray-500">प्रिस्क्रिप्शनचा फोटो क्रॉप किंवा एडिट करू नका.</span>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- Animations -->
<style>
    @keyframes fade-in {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slide-in-left {
        from { opacity: 0; transform: translateX(-30px); }
        to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slide-in-right {
        from { opacity: 0; transform: translateX(30px); }
        to { opacity: 1; transform: translateX(0); }
    }

    .animate-fade-in { animation: fade-in 0.6s ease-out; }
    .animate-slide-in-left { animation: slide-in-left 0.7s ease-out; }
    .animate-slide-in-right { animation: slide-in-right 0.7s ease-out; }
</style>

<!-- JavaScript -->
<!-- JavaScript -->
<script>
    function liveStoreSearch() {
        const query = document.getElementById("store-search").value;
        const suggestionBox = document.getElementById("store-suggestions");
        suggestionBox.innerHTML = '';

        if (query.length > 1) {
            fetch(`/api/search-stores/?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    data.stores.forEach(store => {
    const li = document.createElement("li");
    li.textContent = `${store.store_name} - ${store.address}`;
    li.className = "cursor-pointer px-4 py-2 hover:bg-green-100";
    li.onclick = () => selectStore(store.id, `${store.store_name} - ${store.address}`);
    suggestionBox.appendChild(li);
});

                    suggestionBox.style.display = 'block';
                });
        } else {
            suggestionBox.style.display = 'none';
        }
    }

    function selectStore(id, label) {
        document.getElementById('store-search').value = label;
        document.getElementById('selected-store-id').value = id;
        document.getElementById('store-suggestions').style.display = 'none';
    }

    function toggleAddress() {
        const useSaved = document.querySelector('input[name="address_option"]:checked').value === 'saved';
        const addressField = document.getElementById('delivery-address');
        addressField.readOnly = useSaved;
        if (useSaved) {
            addressField.value = "{{ user.address|escapejs }}";
        } else {
            addressField.value = "";
            addressField.focus();
        }
    }

    document.addEventListener('click', function (e) {
        const searchBox = document.getElementById('store-search');
        const suggestions = document.getElementById('store-suggestions');
        if (!searchBox.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.style.display = 'none';
        }
    });
</script>
{% endblock %}
